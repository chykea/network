## TCP如何实现可靠传输
1. 校验和
2. 超时重传
3. 序号/确认应答（停止等待协议）
4. 滑动窗口
5. 最大消息长度
6. 拥塞控制

### 校验和
通过检验和的方式，接收端可以检测出来数据是否有差错和异常，假如有差错就会直接丢弃TCP段，重新发送。TCP在计算校验和时，会在TCP首部添加一个12字节的伪首部。校验和总共会计算3部分：TCP首部、TCP伪首部、TCP数据

### 超时重传
超时重传指在一个RTT（往返时间）内没有收到应答包，发送方认为丢包了，就会进行重传。一般是设置一个定时器，这个定时器的时间略大于数据包的RTT（往返时间）。

但是在重传的过程中，如果多次没有收到对方的应答包，那么发送端就会认为接收端发生异常，会强制关闭TCP连接。

### 序号/确认应答
在传输过程中，TCP首部会带上seq，表示数据的序号。接收方收到后会从seq开始计算，然后在应答时首部带上ack，表示收到，并通知发送方下一次发送从哪个序号开始。在发送方发送数据包后，如果没有收到应答包，都会重发，即超时重传，保证了数据的完整性。

### 最大长度
这里需要理解一些概念，比如传统以太网的帧的最大长度为1518个字节，除去帧头帧尾有18个字节，帧的数据载荷部分为1500个字节，而帧的数据载荷部分是所能包含的ip数据报的长度（ip数据报的长度最大为65535个字节），如果ip数据报超出了1500个字节（固定首部20个字节+数据载荷1480个字节），就会进行分片，这个是网络层的。而传输层的，以TCP为例，在ip数据报的数据载荷部分，就是TCP报文的最大长度（1480=TCP固定首部20个字节+TCP数据载荷部分1460个字节）。除去TCP首部所需的字节，发送端和接收端在TCP所能传输的消息最大长度为1460个字节。

### 滑动窗口
上面提到的超时重传其实存在效率低下的问题，即需要等待确认报文后才会发送下一个报文。滑动窗口就是用于解决这个问题的。

窗口的大小就是在无需等待确认包的情况下，发送端还能发送的最大数据量。这个机制其实就是使用了大量的缓存区，通过对多个报文进行确认应答的功能。

那么发送端怎么确认接收端是否接收到数据呢？或者怎么知道需要重传的数据有哪些呢？如下图

![](TCP%E7%9A%84%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3.jpg)

接收端如果没有接收到自己所期望的数据时，会对之前的数据包进行重复确认，然后发送端收到某个应答包后，又收到3个重复的应答包，这时发送端就知道对应的数据已经丢失了，需要重发。


### 拥塞控制
通过慢开始、拥塞避免、快重传、快恢复进行拥塞控制
- 慢开始
1. 在初始阶段，发送方会维护一个拥塞窗口cwnd变量，其值取决于网络的拥塞程度，且动态变化。
2. 维护原则：只要没有发送拥塞，拥塞窗口就增大，但只要出现拥塞，窗口就减小
3. 判断出现拥塞原则：发生超时重传。
4. 发送方将拥塞窗口作为发送窗口swnd，即swnd = cwnd
5. 维护一个慢开始阈值变量`ssthresh`,在TCP中，该阈值的初始值为64KB
    - 当cwnd < ssthresh，使用慢开始算法，即cwnd = cwnd*2
    - 当cwnd = ssthresh，既可以使用慢开始算法，使用拥塞避免算法（主要），即cwnd = cwnd + 1;
    - 当cwnd > ssthresh，使用拥塞避免算法，停止使用慢开始算法
- 拥塞控制
1. 此时cwnd是线性增长的
2. 在进行拥塞控制的时候，可能会遇到两种情况：
    - 到某个阶段，发送方所发送的所有报文，接收方都没有接收到，超时重传，此时发送方判断网络可能出现拥塞。
    - 某个报文丢失，而其他报文被接收方正常接收
> 第一种情况。已经进行超时重传，此时会进行以下操作
> - 将ssthresh设置为发生拥塞时cwnd的值的一半，即 ssthresh = cwnd / 2;
> - 将cwnd设置为1
> - 然后进行慢开始算法

> 第二种情况。某个报文丢失，但此时网络并没发生拥塞，其他报文接收端能够正常接收。此时则会进行以下操作
> - 接收端接收到其他报文，但判断出缺少某个报文，此时会进行发送三次重复确认丢失报文的前一个已经接收到的报文。
> - 发送端收到连续三个重复确认报文后，会立刻发送丢失的报文，而不必等到超时重传，也就不会误以为发生拥塞而错误的减小cwnd
> - 发送方也不会启动慢开始算法，而是启动快恢复算法，即ssthresh = cwnd / 2; cwnd = ssthresh。 